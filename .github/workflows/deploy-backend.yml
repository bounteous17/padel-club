name: Deploy Backend

on:
  push:
    branches: [master]
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: eu-central-1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Build TypeScript
        working-directory: backend
        run: npm run build

      - name: Generate Prisma client
        working-directory: backend
        run: npx prisma generate

      - name: Create deployment package
        run: |
          cd backend
          tar -czf ../backend-deploy.tar.gz \
            dist/ \
            prisma/ \
            package.json \
            package-lock.json

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-deploy
          path: backend-deploy.tar.gz
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-deploy

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Upload to S3 (temporary)
        run: |
          aws s3 cp backend-deploy.tar.gz s3://${{ vars.S3_BUCKET_NAME }}/deploy/backend-deploy.tar.gz

      - name: Deploy to EC2 via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ vars.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /opt/padel-club",
              "aws s3 cp s3://${{ vars.S3_BUCKET_NAME }}/deploy/backend-deploy.tar.gz .",
              "tar -xzf backend-deploy.tar.gz",
              "rm backend-deploy.tar.gz",
              "npm ci --production",
              "npx prisma migrate deploy",
              "sudo systemctl restart padel-club",
              "echo Deploy completed at $(date)"
            ]' \
            --output text \
            --query "Command.CommandId")

          echo "Command ID: $COMMAND_ID"

          # Wait for command to complete
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "Status" --output text 2>/dev/null || echo "Pending")

            echo "Status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "Deployment successful!"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ]; then
              echo "Deployment failed!"
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                --query "StandardErrorContent" --output text
              exit 1
            fi

            sleep 10
          done

          echo "Deployment timed out"
          exit 1

      - name: Cleanup S3 deployment file
        if: always()
        run: |
          aws s3 rm s3://${{ vars.S3_BUCKET_NAME }}/deploy/backend-deploy.tar.gz || true
